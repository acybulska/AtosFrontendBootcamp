<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
        crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
    <title>Book Details</title>
</head>

<body>
    <header>
        <div class="navbar narvar-dark box-shadow bg-dark">
            <div class="container d-flex justify-content-between">
                <a class="navbar-brand" href="index.html">
                    <h1 class="text-white">
                        <i class="fas fa-book text-white"></i> My Book Colection</h1>
                </a>
                <button type="button" class="btn btn-link" onclick="getNewBook()">
                    <h5 class="text-white">
                        <i class="fas fa-plus text-white"></i> Add book</h5>
                </button>
                <div class="form-inline">
                    <input type="search" aria-label="Search" class="form-control" id="searchInput" placeholder="Search">
                    <div class="input-group-append">
                        <button class="btn btn-light" type="submit" onclick="searchElement()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="container py-5">
        <form>
            <fieldset id="separateBooks">
                <div id="anotherBook"></div>
                <div class="row justify-content-center">
                    <button id="addAnotherBtn" type="button" class="btn btn-link" onclick="addAnotherBook(++bulkAddCounter)">
                        <i class="far fa-plus-square"></i> Add another</button>
                </div>
                <div class="row justify-content-center">
                    <button type="button" class="btn btn-dark" onclick="saveBooks()">Save</button>
                    <button type="button" class="btn btn-dark" id="deleteBtn" onclick="deleteBook()">Delete</button>
                    <button type="button" class="btn btn-dark" onclick="goBack()">Back</button>
                </div>
            </fieldset>
        </form>
        <div class="row justify-content-center">
            <button id="addFromFileBtn" type="button" class="btn btn-link" onclick="addFromFile()">
                <i class="far fa-plus-square"></i> Add from file</button>
        </div>
        <form>
            <fieldset id="fileBooks">
                <div class="row justify-content-center">
                    <p>Choose a text file with books entered in such manner: [{"title" : "Book 1 title", "description" : "Book
                        1 author"}, {"title" : "Book 2 title", "description" : "Book 2 author"}, ... ,{"title" : "Book N
                        title", "description" : "Book N author"}]
                    </p>
                </div>
                <div class="row justify-content-center">
                    <form class="form-group">
                        <input id="addFile" type="file" accept="text/*">
                        <label class="sr-only" for="addFile">Add file</label>
                        <div class="input-group-append">
                            <button id="addFileSubmit" class="btn btn-dark" onclick="saveBooks()" type="button">Submit</button>
                        </div>
                    </form>
                    <button id="addFromFileCancelBtn" type="button" class="btn btn-outline-dark" onclick="addFromFileCancel()">Cancel</button>
                </div>
                <div class="row justify-content-center">
                    <table id="booksFileTable">
                        <tbody></tbody>
                    </table>
                </div>
            </fieldset>
        </form>
    </main>
    <footer class="footer bg-dark">
        <div class="container">
            <span class="text-white">by Lisa Swann</span>
        </div>
    </footer>
    <script>
        var id = null;
        var bulkAddCounter = 0;
        var booksFile = [];
        document.getElementById('addFile').addEventListener('change', readSingleFile, false);

        $(document).ready(function () {
            id = window.location.hash.substring(1);
            addAnotherBook(0);
            if (id == "undefined") {
                document.getElementById("fileBooks").style.visibility = "hidden";
                document.getElementById("deleteBtn").style.display = "none";
            }
            else {
                document.getElementById("addFromFileBtn").style.display = "none";
                document.getElementById("fileBooks").style.display = "none";
                document.getElementById("addAnotherBtn").style.display = "none";
                $.ajax({
                    url: 'http://bootcamp.opole.pl/books/my-books/mx5t',
                    type: 'GET',
                    success: function (result) {
                        for (var i = 0; i < result.books.length; i++) {
                            if (result.books[i].id == id) {
                                document.getElementById("bookAuthor" + i).value = result.books[i].description;
                                document.getElementById("bookTitle" + i).value = result.books[i].title;
                            }
                        }
                        console.log("GET Status: " + result.status);
                    },
                    error: function () {
                        window.location.href = 'notfound.html';
                    }
                })
            }
        });

        function addFromFile() {
            document.getElementById("separateBooks").disabled = true;
            document.getElementById("fileBooks").style.visibility = "visible";

        }
        function addFromFileCancel() {
            document.getElementById("fileBooks").style.visibility = "hidden";
            document.getElementById("separateBooks").disabled = false;
        }
        function readSingleFile(evt) {
            var f = evt.target.files[0];
            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var contents = e.target.result;
                    console.log("Got the file with: " + contents);
                    booksFile = JSON.parse(contents);
                    $("#booksFileTable").append('<tr><th>PREVIEW</th><th></th></tr>' +
                        '<tr><th>Title</th><th>Author</th></tr>');
                    for (var k = 0; k < booksFile.length; k++) {
                        $("#booksFileTable").append('<tr><td>' + booksFile[k].title + '</td><td>' + booksFile[k].description + '</td></tr>');
                    }
                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }

        function saveBooks() {
            if (id === "undefined") {

                if (booksFile === [] && bulkAddCounter === 0) {
                    console.log("Noting to add");
                }
                else if (bulkAddCounter !== 0) {
                    for (const i of bulkAddCounter) {
                        var book = {
                            "title": document.getElementById("bookTitle" + i).value,
                            "description": document.getElementById("bookAuthor" + i).value
                        };
                        addNextBook(book);
                    }
                }
                else {
                    if (booksFile !== "" && booksFile !== []) {
                        for (const book of booksFile) {
                            var bookJson = {
                                "title": item.title,
                                "description": item.description
                            };
                            addNextBook(bookJson);
                        }
                    }
                    else {
                        console.log("Empty or unknown file");
                    }
                }
                alert("OK");
                window.location.href = "index.html";
            }
            else {
                editBook(id);
            }
        }

        function addNextBook(item) {
            if (item.title !== "" || item.description !== "") {
                $.ajax({
                    url: 'http://bootcamp.opole.pl/books/add-book/mx5t',
                    type: 'POST',
                    data: item,
                    success: function (result) {
                        console.log("Status " + i + ": " + result.status);
                    },
                    error: function () {
                        console.log("Status " + i + ": error");
                    }
                })
            }
        }
        function addAnotherBook(id) {
            var elm = '<div class="row justify-content-center">' +
                '<div class="form-group"> ' +
                '<label for="bookAuthor">Author</label>' +
                '<input id="bookAuthor' + id + '" type="text" class="form-control">' +
                '</div>' +
                '<div class="form-group"> ' +
                '<label for="bookTitle">Title</label>' +
                '<input id="bookTitle' + id + '" type="text" class="form-control">' +
                '</div></div>';
            $("#anotherBook").append(elm);
        }

        function editBook(id) {
            var book = {
                "title": document.getElementById("bookTitle0").value,
                "description": document.getElementById("bookAuthor0").value,
                "id": id
            };
            $.ajax({
                url: 'http://bootcamp.opole.pl/books/edit-book/' + id + '/mx5t',
                type: 'POST',
                data: book,
                success: function (result) {
                    window.location.href = 'index.html';
                },
                error: function () {
                    window.location.href = 'notfound.html';
                }
            })
        };

        function deleteBook() {
            console.log(id);
            var del = confirm("Are you sure you want to delete this book?");
            if (del == true) {
                $.ajax({
                    url: 'http://bootcamp.opole.pl/books/delete-book/' + id + '/mx5t',
                    type: 'DELETE',
                    success: function (result) {
                        window.location.href = 'index.html';
                    },
                    error: function () {
                        window.location.href = 'notfound.html';
                    }
                })
            }
        };

        function goBack() {
            window.location.href = 'index.html';
        };

        function getNewBook(id) {
            window.location.href = 'book.html' + '#' + id;
            window.location.reload();
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em"
        crossorigin="anonymous"></script>
</body>

</html>